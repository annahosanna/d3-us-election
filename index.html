<!DOCTYPE html>
<meta charset="utf-8">

<head>
    <script src="//d3js.org/d3.v3.min.js"></script>
    <script src="//d3js.org/topojson.v1.min.js"></script>

    <link rel="stylesheet" type="text/css" href="style.css">
</head>

<body>
    <div class="michigan"></div>
    <div class="whole-us"></div>

    <script>
        var width = 960,
            height = 500,
            active = d3.select(null);

        var projection = d3.geo.albersUsa()
            .scale(1000)
            .translate([width / 2, height / 2]);
        var path = d3.geo.path()
            .projection(projection);

        var svg = d3.select(".whole-us").append("svg")
            .attr("width", width)
            .attr("height", height);

        svg.append("rect")
            .attr("class", "background")
            .attr("width", width)
            .attr("height", height)
            .on("click", reset);

        var g = svg.append("g")
            .style("stroke-width", "1.5px"); 

        var stateColour = {};
        var stateData = {};
        
        //Parse in state-data
        d3.json("/data/state-data.json", function(error, data){
          if(error) throw error;

          

          data.forEach(function(d, i){
            stateData[d.id] = d;
            stateColour[d.id] = d.colour;
          })

          console.log(stateData);
          //console.log(stateColour);
        }) 

        var tooltip = d3.select('.whole-us').append('div')
            .attr('class', 'hidden tooltip');

        d3.json("/data/us.json", function(error, us) {
            if (error) throw error;

            g.selectAll("path")
                .data(topojson.feature(us, us.objects.states).features)
                .enter().append("path")
                .attr("d", path)
                .attr("class", "feature")
                .attr("name", function(d){ 
                  for(var i = 0; i < stateData.length; i++){
                    if(typeof stateData[d.id] === 'undefined')
                      return "";
                  }
                  return stateData[d.id].name;})
                .style("fill", function(d){
                    return "#" + stateColour[d.id];
                })
                .on("mousemove", function (d) { 
                    d3.select(this).style("opacity", .8); 
                    var mouse = d3.mouse(svg.node()).map(function(d) {
                        return parseInt(d);
                    });
                    tooltip.classed('hidden', false)
                        .attr('style', 'left:' + (mouse[0] + 15) +
                                'px; top:' + (mouse[1] - 35) + 'px')
                        .html(stateData[d.id].name);
                  })
                .on("mouseout", function () { 
                    tooltip.classed('hidden', true);
                    d3.select(this).style("opacity", 1).style("fill", function(d){
                      return "#" + stateColour[d.id];
                    }); 
                  })
                .on("click", clicked);

            /*g.append("path")
                .datum(topojson.mesh(us, us.objects.counties, function(a, b) {
                    return a !== b;
                }))
                .attr("class", "meshCounty")
                .attr("d", path); */

            g.append("path")
                .datum(topojson.mesh(us, us.objects.states, function(a, b) {
                    return a !== b;
                }))
                .attr("class", "mesh")
                .attr("d", path)
                .on("click", clicked); 

            
        });

        function clicked(d) {
            if (active.node() === this) return reset();
            active.classed("active", false);
            active = d3.select(this).classed("active", true);

            console.log(d3.select(this).attr("name"));

            var bounds = path.bounds(d),
                dx = bounds[1][0] - bounds[0][0],
                dy = bounds[1][1] - bounds[0][1],
                x = (bounds[0][0] + bounds[1][0]) / 2,
                y = (bounds[0][1] + bounds[1][1]) / 2,
                scale = .9 / Math.max(dx / width, dy / height),
                translate = [width / 2 - scale * x, height / 2 - scale * y];

            g.transition()
                .duration(750)
                .style("stroke-width", 1.5 / scale + "px")
                .attr("transform", "translate(" + translate + ")scale(" + scale + ")");
        }

        function reset() {
            active.classed("active", false);
            active = d3.select(null);

            g.transition()
                .duration(750)
                .style("stroke-width", "1.5px")
                .attr("transform", "");
        }

        d3.select(self.frameElement).style("height", height + "px");
    </script>
</body>